<!DOCTYPE html>
<!-- saved from url=(0070)file:///D:/Etty%20Golan/Downloads/digit_span_qualtrics_full%20(5).html -->
<html lang="he" dir="rtl"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Digit Span – משולב (קדימה ואז אחורה) | גרסה סופית לגורילה – מתוקנת</title>
  <style>
    :root {
      --bg: #f4f7fb;
      --bg-accent: #eaf2ff;
      --card: #ffffff;
      --text: #1a2233;
      --muted: #5c6a86;
      --accent: #0d6efd;
      --accent-2: #11b5a4;
      --border: #dfe7f3;
      --hint: #6f7d98;
      --notice-bg: #fff6e6; --notice-bd:#ffe0a6; --notice-tx:#8a5a00;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial,"Segoe UI",system-ui; background:linear-gradient(180deg,var(--bg), var(--bg-accent) 70%, var(--bg)); color:var(--text); }
    .wrap{ max-width:900px; margin:28px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; padding:24px; box-shadow:0 20px 50px rgba(16,42,67,.08); }
    h1{ margin:0 0 12px; font-size:28px; color:#13203b }
    .subtitle{ color:var(--muted); margin:0 0 18px; font-size:16px }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .badge{ display:inline-block; background:#e6f2ff; color:#0b5ed7; padding:4px 10px; border:1px solid #cde2ff; border-radius:999px; font-size:12px; margin-inline-start:8px }
    .btn{ appearance:none; border:1px solid var(--border); background:#f7fbff; color:#0b3b67; padding:12px 18px; border-radius:12px; cursor:pointer; font-size:18px; }
    .btn.primary{ background:linear-gradient(90deg,var(--accent), var(--accent-2)); border:none; color:#fff }
    .btn:disabled{ opacity:.55; cursor:not-allowed }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; color:#2a3a57; font-size:13px }
    .kpi{ background:#f3f7ff; padding:8px 12px; border-radius:10px; border:1px solid var(--border) }
    .screen{ text-align:center; padding:28px 10px; min-height:180px; display:flex; align-items:center; justify-content:center; }
    #digit{ font-size:60px; letter-spacing:.12em; color:#0b3b67 }
    #keypad{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:12px }
    .key{ padding:16px; font-size:22px; border-radius:12px; border:1px solid var(--border); background:#ffffff; color:#0b3b67; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.03) }
    .inputBox{ font-size:22px; padding:12px; width:100%; border-radius:10px; border:1px solid var(--border); background:#ffffff; color:#0b3b67 }
    .hint{ color:var(--hint); font-size:14px }
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    .hr{ height:1px; background:var(--border); margin:16px 0 }
    .phase{ font-weight:bold; color:#0b5ed7 }
    .notice{ background:var(--notice-bg); border:1px solid var(--notice-bd); color:#8a5a00; padding:14px; border-radius:12px; }
    .phase-banner{ background:#e6f2ff; border:1px solid #cfe3ff; padding:10px 14px; border-radius:12px; color:#0b5ed7; font-weight:700; font-size:18px; }
    .phase-banner.alt{ background:#e9fff8; border-color:#ccf7ee; color:#0a8f82 }
    .inst-big{ font-size:22px; line-height:1.8; color:#082c52; background:#eef5ff; border:1px solid #dbe8ff; border-radius:12px; padding:14px 16px; }
    .inst-big.alt{ background:#eafff9; border-color:#ccf7ee; color:#06473f }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-labelledby="title">
      <h1 id="title">מטלת Digit Span – גרסה משולבת <span class="badge">קדימה ואז אחורה</span></h1>
      <p class="subtitle">תרגול קצר → שלב קדימה → מסך מעבר ברור → שלב אחורה → סיום.</p>

      <div class="row meta" aria-live="polite">
        <div class="kpi">שלב: <span id="phaseLabel" class="phase">הוראות</span></div>
        <div class="kpi">Raw Score: <span id="raw">0</span></div>
        <div class="kpi">אורך נוכחי: <span id="len">—</span></div>
      </div>

      <div class="hr"></div>

      <div id="phaseBanner" class="phase-banner">הוראות פתיחה</div>
      <div id="instructions" aria-live="polite" style="margin-top:10px;">
        <div id="instText" class="inst-big">
          במטלה זו יוצגו בפניך ספרות בזו אחר זו.<br>
          תחילה תבצע/י <b>ניסיון תרגול קצר (לא נחשב לציון)</b> כדי להבין את הפעולה: לזכור את הספרות <u>בסדר שבו הופיעו</u> ולהקליד אותן באותו סדר.<br>
          לאחר מכן יחל החלק הראשון (קדימה), ולבסוף החלק השני (אחורה).
        </div>
      </div>

      <div id="screen" class="screen" role="region" aria-live="polite">
        <p class="hint">לחץ/י על “התחל תרגול” כדי להתחיל בתרגול הקצר.</p>
      </div>

      <div id="response" aria-live="polite"></div>

      <div id="footer" class="hint" style="margin-top:10px;">
        טיפ: אפשר להקליד במקלדת (0–9) או להשתמש בלוח המקשים על המסך. לחיצה על ״Backspace״ מוחקת ספרה.
      </div>

      <div class="hr"></div>

      <div class="row" id="startRow">
        <button id="startPractice" class="btn primary" aria-label="התחל תרגול">התחל תרגול</button>
      </div>

    </div>
  </div>

<script>
const PARAMS = { START_LEN:3, MAX_LEN:9, ISI_MS:1000, ATTEMPTS:2 };
const paramsURL = new URLSearchParams(window.location.search);
const PID = paramsURL.get('pid') || 'NA';
const REDIRECT_URL = paramsURL.get('redirect') || 'https://YOURSUB.qualtrics.com/jfe/form/XXXXXXXX';

const FLOW = ["practice", "forward", "interstitial", "backward", "end"];
let stageIndex = 0;
let length, attemptsUsed, rawScore, trialLog, running;

const $screen = document.getElementById('screen');
const $response = document.getElementById('response');
const $phaseLabel = document.getElementById('phaseLabel');
const $instText = document.getElementById('instText');
const $rawEl = document.getElementById('raw');
const $lenEl = document.getElementById('len');
const $phaseBanner = document.getElementById('phaseBanner');
const $startPractice = document.getElementById('startPractice');
const $startRow = document.getElementById('startRow');

function randint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function genSequence(n){ return Array.from({length:n}, ()=> randint(0,9)); }

function setUIByStage(){
  const st = FLOW[stageIndex];
  if (st === "practice"){
    $phaseLabel.textContent = "תרגול";
    $phaseBanner.textContent = "ניסיון תרגול (לא נחשב לציון)";
    $phaseBanner.className = "phase-banner";
    $instText.className = "inst-big";
    $instText.innerHTML = 'בתרגול: זכור/י את הספרות <b>בסדר שבו הופיעו</b> והקליד/י באותו סדר. לאחר התרגול יחל החלק הראשון (קדימה).';
  } else if (st === "forward"){
    $phaseLabel.textContent = "קדימה";
    $phaseBanner.textContent = "שלב ראשון: קדימה (אותו סדר)";
    $phaseBanner.className = "phase-banner";
    $instText.className = "inst-big";
    $instText.innerHTML = 'בשלב זה: זכור/י את הספרות <u>בסדר שבו הופיעו</u>. בסיום כל סדרה הזן/י את הספרות באותו סדר.';
  } else if (st === "interstitial"){
    $phaseLabel.textContent = "מעבר";
    $phaseBanner.textContent = "החלק הראשון הסתיים";
    $phaseBanner.className = "phase-banner";
    $instText.className = "inst-big";
    $instText.innerHTML = 'מעולה! סיימת את השלב הראשון. כעת נעבור ל<b>שלב השני</b>: זכירת ספרות <u>בסדר הפוך</u>.';
  } else if (st === "backward"){
    $phaseLabel.textContent = "אחורה";
    $phaseBanner.textContent = "שלב שני: אחורה (סדר הפוך)";
    $phaseBanner.className = "phase-banner alt";
    $instText.className = "inst-big alt";
    $instText.innerHTML = 'בשלב זה: זכור/י את הספרות <b>בסדר הפוך</b> – מהסוף להתחלה. בסיום כל סדרה הזן/י את הספרות בסדר ההפוך.';
  } else {
    $phaseLabel.textContent = "סיום";
    $phaseBanner.textContent = "סיום המטלה";
  }
}

function showSequence(seq, ISI_MS){
  $screen.innerHTML = '<div id="digit" aria-live="polite">+</div>';
  const $digit = document.getElementById('digit');
  let idx = -1;
  const timer = setInterval(()=>{
    idx += 1;
    if (idx >= seq.length){
      clearInterval(timer);
      requestResponse(seq);
    } else {
      $digit.textContent = seq[idx];
      $lenEl.textContent = seq.length;
    }
  }, ISI_MS);
}

function renderKeypad(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <label class="sr-only" for="respInput">הקלידו כאן את התשובה</label>
    <input id="respInput" class="inputBox" inputmode="numeric" autocomplete="off" placeholder="הקלידו כאן…" aria-label="שדה קלט לתשובה"/>
    <div id="keypad" aria-label="לוח מקשים מספרי" style="margin-top:8px;">
      ${[1,2,3,4,5,6,7,8,9,0].map(d=>`<button type="button" class="key" data-digit="${d}" aria-label="ספרה ${d}">${d}</button>`).join('')}
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="submit" class="btn primary" aria-label="אישור">אישור</button>
      <button id="clear" class="btn" aria-label="ניקוי">ניקוי</button>
    </div>
  `;
  return wrap;
}

function requestResponse(seq){
  $response.innerHTML = '';
  const ui = renderKeypad();
  $response.appendChild(ui);
  const $inp = document.getElementById('respInput');
  const $submit = document.getElementById('submit');
  const $clear = document.getElementById('clear');

  ui.querySelectorAll('.key').forEach(k=> k.addEventListener('click', ()=>{
    $inp.value += k.dataset.digit;
    $inp.focus();
  }));
  $clear.addEventListener('click', ()=>{ $inp.value=''; $inp.focus(); });
  $submit.addEventListener('click', ()=> grade(seq, $inp.value.trim()) );

  window.onkeydown = (ev)=>{
    if (!running) return;
    const focusedInInput = (document.activeElement === $inp);
    if (focusedInInput){
      // Ignore Enter so it won't submit mid-trial
      if (ev.key === 'Enter'){ ev.preventDefault(); }
      return;
    }
    if (/^[0-9]$/.test(ev.key)){ ev.preventDefault(); $inp.value += ev.key; }
    else if (ev.key === 'Backspace'){ ev.preventDefault(); $inp.value = $inp.value.slice(0,); }
    else if (ev.key === 'Enter'){ ev.preventDefault(); $submit.click(); }
  };

  $inp.focus();
  $screen.innerHTML = '<p class="hint">הזינו את הסדרה עכשיו.</p>';
}

function normalizeResponse(str){
  return (str||'').replace(/\D+/g,'').split('').map(x=>parseInt(x,10));
}

function logMetric(payload){
  try{
    if (window.gorilla && typeof gorilla.metric === 'function'){ gorilla.metric(payload); }
  }catch(e){ /* ignore */ }
}

function grade(seq, respStr){
  const st = FLOW[stageIndex];
  const entered = normalizeResponse(respStr);
  let target = seq.slice();
  if (st === 'backward'){ target = target.slice().reverse(); }

  const correct = (entered.length === target.length) && entered.every((v,i)=> v===target[i]);

  const record = { phase: st, length: seq.length, attempt: attemptsUsed+1, sequence: seq.join(''), target: target.join(''), response: entered.join(''), correct: correct };
  (trialLog||[]).push(record);
  logMetric({ event: (st==='practice' ? 'practice' : 'trial'), ...record });

  if (st === 'practice'){
    $screen.innerHTML = `<div class="notice"><b>${correct ? 'מצוין!' : 'תודה.'}</b> זה היה ניסיון תרגול בלבד. כעת נמשיך לחלק הראשון של המטלה (קדימה).</div>`;
    $response.innerHTML = '<div class="row" style="margin-top:12px;"><button id="goForward" class="btn primary">המשך</button></div>';
    document.getElementById('goForward').onclick = ()=> { stageIndex = 1; startStage(); };
    return;
  }

  if (correct){
    rawScore += 1;
    $rawEl.textContent = rawScore;
    length += 1;
    attemptsUsed = 0;
    if (length > PARAMS.MAX_LEN){ nextStageOrFinish(); return; }
  } else {
    attemptsUsed += 1;
    if (attemptsUsed >= PARAMS.ATTEMPTS){ nextStageOrFinish(); return; }
  }

  // Prepare next trial: clear response area and disable keyboard while the sequence is shown
  window.onkeydown = null;
  $response.innerHTML = '';

  const nextSeq = genSequence(Math.min(length, PARAMS.MAX_LEN));
  showSequence(nextSeq, PARAMS.ISI_MS);
}

function interstitialScreen(){
  setUIByStage();
  $response.innerHTML = '';
  $screen.innerHTML = `
    <div class="notice" role="alert">
      <div style="font-size:22px; font-weight:800; margin-bottom:6px;">החלק הראשון הסתיים</div>
      <div style="font-size:18px;">כעת תעבור/י לחלק השני – זכירת ספרות <b>בסדר הפוך</b>.</div>
      <div class="hint" style="margin-top:6px;">לחץ/י על "המשך לשלב הבא" כדי להמשיך.</div>
      <div class="row" style="margin-top:12px;">
        <button id="goNext" class="btn primary">המשך לשלב הבא</button>
      </div>
    </div>
  `;
  document.getElementById('goNext').onclick = ()=>{ stageIndex = 3; startStage(); };
}

function finishTask(){
  // Stop task & keyboard listening
  running = false;
  window.onkeydown = null;

  // If running inside Gorilla, still send a summary metric (backwards-compatible)
  try{
    if (window.gorilla && typeof gorilla.metric === 'function'){
      gorilla.metric('summary', {
        rawScore: rawScore,
        totalTrials: (trialLog || []).length,
        trialLog: trialLog
      });
    }
  }catch(e){ /* ignore */ }

  // Show end-of-task message on screen
  $screen.innerHTML = '<h3 role="heading" aria-level="2">סיום המטלה</h3><p>תודה על השתתפותך! מעבר אוטומטי לשאלון הבא…</p>';
  $response.innerHTML = '';

  // If running inside Gorilla, allow it to close the task as usual
  try{
    if (window.gorilla && typeof gorilla.finish === 'function'){
      gorilla.finish();
    }
  }catch(e){ /* ignore */ }

  // --- Redirect / Qualtrics integration ---
  try{
    const params = new URLSearchParams();
    params.set('pid', PID);
    params.set('rawScore', String(rawScore));
    params.set('totalTrials', String(trialLog ? trialLog.length : 0));
    if (trialLog){
      params.set('trialLog', JSON.stringify(trialLog));
    }

    let url = REDIRECT_URL;
    const joiner = url.includes('?') ? '&' : '?';
    url = url + joiner + params.toString();

    // Notify parent page (e.g., Qualtrics) that the task is finished
    try{
      window.parent.postMessage('taskFinished', '*');
    }catch(e){ /* ignore */ }

    setTimeout(()=>{ window.location.href = url; }, 800);
  }catch(e){
    // Fallback: minimal redirect with pid only
    const url = REDIRECT_URL + (REDIRECT_URL.includes('?') ? '&' : '?') + 'pid=' + encodeURIComponent(PID);

    try{
      window.parent.postMessage('taskFinished', '*');
    }catch(e2){ /* ignore */ }

    setTimeout(()=>{ window.location.href = url; }, 800);
  }
}


function startStage(){
  setUIByStage();
  running = true;
  $response.innerHTML = '';

  if (FLOW[stageIndex] === 'practice'){ length = 3; attemptsUsed = 0; }
  else { length = Math.max(2, PARAMS.START_LEN); attemptsUsed = 0; }

  $lenEl.textContent = length;
  const seq = genSequence(length);
  showSequence(seq, PARAMS.ISI_MS);
}

function nextStageOrFinish(){
  if (FLOW[stageIndex] === 'forward'){ stageIndex = 2; interstitialScreen(); }
  else if (FLOW[stageIndex] === 'backward'){ stageIndex = 4; finishTask(); }
}

$startPractice.addEventListener('click', ()=>{
  if ($startRow) $startRow.remove();
  stageIndex = 0;
  rawScore = 0; trialLog = [];
  $rawEl.textContent = '0';
  startStage();
});

history.pushState(null, document.title, location.href);
window.addEventListener('popstate', function(){ history.pushState(null, document.title, location.href); });
</script>


</body></html>